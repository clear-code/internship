# メンターのインターンシップメモ: 2013-07-16

12日目。9:30 - 18:00。

以下を実施した。今日も違う作業をしながら見守っていた。

- 朝会の司会
- エラーメッセージについて
- groonga-commandにcolumn_createコマンド用の機能を追加
- fluent-plugin-droongaでcolumn_createコマンドをrroongaのAPIに変換
- fluent-plugin-droongaにデータを追加するAPIについて検討
- fluent-plugin-droongaにaddコマンドを実装
- rroongaのdumperのバグを修正

## 朝会の司会

ちょうど順番が回ってきたので、初めて朝会の司会をしてもらった。

朝会は最初にどうしてやるかとどうやるかを説明し、これまでに11回参加して
いるので、どういうものかはわかっている。他の人が司会をやっている様子も
11回見ている。ただ、実際にやったことはない。

このような状況で、一回目で新しい役割をうまくできるかどうかに興味があっ
たので、司会をやってもらう前に、「やった後に自分基準でいいのでうまくで
きたと思ったかどうかを教えて欲しい」とお願いした。朝会30分前に今日の司
会をお願いする旨を伝えた。準備する時間は十分だった。

実際にやっている様子を見ていると、アイスブレークの一言も「○○がありま
した。以上」だけではなく、自分はこう思ったとかも入っていてアイスブレー
クになっていた。

やった後に自分基準でどう思ったかを聞いてみたところ、そつなくできたとい
うことだった。

他の人からは、同じような状況でも最初はうまくできなかったということを聞
いていたので、そうなるかと思ったがそうではなかった。あさみさんは個体差
じゃないですか？と言っていたけど、まぁ、そうだろうとは思う。

事前に30分準備時間があれば最初からでもうまくケースがあったということは
事実なので、今後、機会があったら最初は30分準備時間を確保する、というの
は試してみたい。

### エラーメッセージについて

fluent-plugin-droongaでの `table_create` コマンドの実装でエラーをどう処
理するかについて相談してもらった。

今は、fluent-plugin-droongaでエラーチェックしているケースとrroongaに渡
してエラーになったらそのエラー情報を返すケースがある。（実際はまだ実装
していないのでないんだけど、そういう作りにしようという話はしていた。）
これを、全部rroongaのエラーチェックで対応してしまうのがよいのではないか、
ということだった。

これに対して、私はエラーメッセージを作るときに何に気を付けているかを思
い出しながら説明を試みた。

まず、エラーメッセージをなぜだすのか？ということを考えてもらった。「な
んでエラーになったかわからないとしんどいから」かなぁということだった。
私もそんな感じだ。ただ、私は、もう少し細かく考えているような気がしたの
で思い出し思い出ししながら説明を始めた。

まず、「だれが」しんどいかを意識している。あまり実装の詳細を知らない
「一般ユーザー」だったり、技術的なことがわかる「開発者」だったり、エラー
メッセージがないと「だれが」しんどくなるかを意識している。「だれが」に
よって適切なエラーメッセージの粒度が変わってくる。

また、「どのように」しんどいかも意識している。エラーになった後に復旧で
きるかどうかがポイントだと考えている。エラーになっても復旧するための情
報を提供できていればしんどさを減らすことができるということである。

例えば、郵便番号を入力するフォームで「 `/\A\d{3}-d{4}\z/` という正規表
現にマッチしません。」というエラーメッセージがでたとする。開発者なら入
力をどのように直せばよいかわかるだろう。しかし、正規表現を知らない一般
ユーザーは入力を直せばよいかわからないので適切ではない。これは、情報が
「だれが」に適していないケースである。

他の例も考える。同様に、郵便番号を入力するフォームで「不適切な値です。」
というエラーメッセージがでたとする。もし、すべてマルチバイト文字で指定
しないとエラーにしているシステムならどうだろう。「000-0001」は不適切な
値となる。この場合は必要な情報が不足していてどうすれば復旧できるかわか
らないのでしんどいというケースである。

このように、今用意しようとしているのは、だれのためのエラーメッセージか、
どうすればエラー状態を回避できるのかという情報が含まれているかというこ
とを意識している。

今回の `table_create` コマンドについて当てはめて考える。呼び出し側でエ
ラーチェックをせずにrroongaにエラーチェックを丸投げして、「groongaユー
ザー」（だれ）が「入力エラー」（エラー状態）を回避できるだろうか。

例えば、テーブル名を指定し忘れたとする。このとき、テーブル名は `nil` と
なる。これをそのままrroongaに渡すと以下のようになる。

    Groonga::Schema.create_table(nil)
    ArgumentError: should be String, Symbol or unsigned integer: nil
        from /var/lib/gems/1.9.1/gems/rroonga-3.0.4/lib/groonga/schema.rb:969:in `[]'
        ...

`nil` ではなく文字列かシンボルか符号なし整数で指定してくれ、というエラー
メッセージである。APIを使うプログラマーなら呼び出し方を直せるだろうが、
「groongaユーザー」は `table_create --name XXX ...` のようなコマンドを
指定するしかできない。また、このコマンドの世界では `nil` という概念は存
在しない。そのため、このエラーメッセージを見ても「groongaユーザー」はこ
のエラーをどう回避すればよいかわからない。よって、この場合はrroongaにエ
ラーチェックを丸投げすると「groongaユーザー」にとって適切なエラーメッセー
ジを返せない。

このことから、fluent-plugin-droongaレベルでエラーチェックをしてエラーメッ
セージを作る必要もあるといえる。（すべてfluent-plugin-droongaレベルで
チェックしなければいけないということではない。指定した名前のオブジェク
トが存在するかどうかなどfluent-plugin-droongaレベルではチェックできない
項目もあるからである。）

参考: [問題解決につながるエラーメッセージ](http://www.clear-code.com/blog/2009/4/10.html)

これに関連して
[契約プログラミング（Design by Contract、DbC）](http://ja.wikipedia.org/wiki/%E5%A5%91%E7%B4%84%E3%83%97%E3%83%AD%E3%82%B0%E3%83%A9%E3%83%9F%E3%83%B3%E3%82%B0)
についても少しだけ説明した。事前条件とか事後条件とかEiffelとかオブジェ
クト指向入門とか。

### groonga-commandにcolumn_createコマンド用の機能を追加

`table_create` コマンドの対応が終わったので `column_create` コマンドの
対応に着手した。
[`column_create` コマンドのドキュメント](http://groonga.org/ja/docs/reference/commands/column_create.html)
を確認すると、インデックスカラム以外のときは `table_create` コマンドと
同じように処理できることがわかったので、まずはインデックスカラム以外の
ケースを対応することにした。

TODO: `column_create` コマンドのドキュメントを更新しないといけない。
`table_create` コマンドとか `select` コマンドとかと同じように書くこと。

フラグ周りは `table_create` コマンドと同じようにgroonga-commandで実装し
た。
[一連のコミット](https://github.com/groonga/groonga-command/compare/16b9ad1a21014d2b464c23d34b7890bfe365fffe...1e1612c75337a7ab972e634dcef04c59ad1972d5)
を見ると、1つの機能ずつテスト付きで着実に実装していることがわかる。
`table_create` コマンドと同じパターンだったが、このパターンの開発の仕方
は身についたと言えるだろう。

### fluent-plugin-droongaでcolumn_createコマンドをrroongaのAPIに変換

groonga-commandを使って `column_create` コマンドをrroongaのAPIに変換し
ていった。まず、インデックスカラム以外のカラムについて対応した。これら
のカラムを定義するのは `column` メソッドでいける。

[フラグの対応が一段落](https://github.com/groonga/fluent-plugin-droonga/commit/3d591acb38d45f3f761be208fc4a7ec092969193)
したタイミングで、これから追加するインデックスカラム用の処理とここまで
実装してきた処理で別メソッドにした方がよいのではないかという相談があった。
で、そうだなぁと思ったのでそうすることにした。

その際、 `parse_XXX` という名前は適切じゃなくなったのではないかという話
があった。以前は、 `parse_XXX` の中でフラグの `XXX|YYY|ZZZ` という書式
をパースしていたので `parse_XXX` という名前は適していたが、今はそれらの
処理をgroonga-commandに移動してfluent-plugin-droongaでは単にパースした
結果を使うようになったので適切な名前ではなくなった。ということで、
[`parse_XXX` から `create_XXX_options` という名前に変更](https://github.com/groonga/fluent-plugin-droonga/commit/91fc6a510848204274726070b4fa83552dd7a529)
した。

変更する時、コミットメッセージの書き方について相談があった。相談された
ときはこんな感じで書かれていてような気がする。

    column_create: rename "parse" to "create"

    parse_command ->
    create_column_options

しかし、話の中では、「`parse` が適切じゃないので変えた方がよい」という
理由が挙がっていてのでそれも盛り込んだほうがいいんじゃないかと提案した。
コミットメッセージにするとこう。（typoは直した。）

    column_create: use "create" instead of "parse" for method name

    Because the method doen't parsed. It just creates options for column
    method.

    parse_command ->
    create_column_options

このコミットで大事なことは「`parse` じゃなくて `create` という語を使う
ようにしたこと」と「どうして `create` にしたのかという理由」なので、そ
れを入れるようにしたのがポイントのつもりである。これが採用されて実際の
コミットになった。

このあとは特に相談することもなく順調に進んでいたように見える。
[次にやることがわかっているときはコミットメッセージにTODOでメモしている](https://github.com/groonga/fluent-plugin-droonga/commit/582cebf5484376488fdf52c3c10d65bac5d39f1e)
などこれまでの知見を活かしていると感じる。

### fluent-plugin-droongaにデータを追加するAPIについて検討

スキーマを定義するコマンドを実装したのでepub-searcherから使ってみようか
としたが、HTTPのインターフェイスがまだないことに気づいた。
express-droongaを改良しないといけないことがわかり、それは少しハードルが
高いと感じたため、別の作業を進めることにした。

別の作業として `load` コマンドに相当する機能を作ることにした。しかし、
fluent-plugin-droongaではたくさんのレコードを一気に登録する機能よりも、
1レコードを登録するコマンドをたくさん受け付けるようにする方があっている。
これは、fluentが1つ1つのログを扱うようなフレームワークだからである。

そのため、1つのレコードを追加するコマンドを実装することにした。が、よい
名前が浮かばない。 `table_create` コマンドや `column_create` コマンドを
実装しているときはすでにあるgroongaのコマンドと同じようにするというよう
に、仕様がきっちり決まっていたが、今回はそうではない。とりあえず、いろ
いろだしたアイディアを
[Wikiにまとめて](https://github.com/groonga/express-droonga/wiki/Message-format%3A-record-updating-feature)
、今回は暫定的に `add` と名前を使うことにした。あさみさんもアイディアを
出していたのでよかった。

### fluent-plugin-droongaにaddコマンドを実装

これまで、rroongaでレコードを追加するコードを書いたことはない。はじめて
の機能なので一緒に作業した。といっても、ずっと一緒ではなく、こんな感じ
で実装するというのと、こんな感じでテストを書くというのの8割くらいまで一
緒にやって残りは一人でやってもらうことになった。
[できたものがこちら](https://github.com/groonga/fluent-plugin-droonga/commit/182b438cf63ba86beb6a8b27ace70a72f2ae1106)
。

テスト方法について少し話をした。あさみさんは `table_create` コマンドや
`column_create` コマンドのときと同じようにdumpした結果をテストしようと
していた。しかし、そうじゃなくて、実際にレコードを取得するAPIを使って登
録されたレコードの値を確認したほうがよい、という話をした。

`table_create` コマンドのテストではテーブルが期待したパラメーターで定義
されたことを確認したい。そのためには、テーブルがどのようなパラメーター
で定義されているかが簡潔にわかる方法があると期待値と実際の値を比較しや
すくて都合がよい。 `dump` コマンドを使うとテーブルのパラメーターがすべ
て含まれたgroongaコマンドの文字列で得られるので、テストに都合がよかった
のである。

今回のケースでもdump結果が適切かを考えてみた。dump結果では以下のような
形式で出力される。

    load --table Users
    [
    ["_key"],
    ["mori"]
    ]

今回、知りたい情報は

    [
    ["_key"],
    ["mori"]
    ]

の部分だけなので余計な情報が含まれている。そのため、簡潔さに難がある。
今回の場合は以下で上述の情報と同じものが取得できる。

    users = Groonga["Users"]
    users.collect(&:key) # => ["mori"]

Rubyの配列になっているので、扱いも楽なので、今回はAPIを使って実際の値を
取得するほうが適切であるという説明をした。

説明してみて、テストで比較するために使う実測値には以下のことを（私が）
求めているということがわかった。

- 簡潔な表現であること（余計なことがないこと。必要なことは含まれていること。）
- テストプログラム内で扱いやすい形式であること（文字列よりはオブジェクトの方が操作しやすい。）

### rroongaのdumperのバグを修正

レコードが登録されたかどうかをdumpの結果で確認する・しないの話をしてい
るときに、rroongaのdumperにバグがあることがわかった。カラムが何もないテー
ブルをダンプしないようになっていた。

時間が少しあったので、原因を説明して
[直してもらった](https://github.com/ranguba/rroonga/commit/26c1d6b10a8c137ce48cfbfd8f875028ee393957)
。このときもコミットメッセージどうしましょうねぇと相談してくれた。

相談してきたときはこんな感じだった気がする。

    dumper: fix wrong return value

こういうときは、私ならこんな風にどんなバグを直したかを書くと伝えた。

    dumper: fix a bug that no column table isn't dumped

今回は短く説明できるバグだったので1行目に書いたが、説明が長くなりそうな
ら3行目以降（詳細説明欄）に「こんなバグ」というのを書いている。

今回の3行目以降には以下のように書いた。日本語で言うと「インデックスのみ
のテーブルがダンプされないのは正しいけど、カラムがないテーブルがインデッ
クスのみのテーブルと認識されてダンプされないのは間違っているんだよ。」
みたいなのを表現したかったやつである。で、これが原因として説明していた
ことである。それをコミットメッセージにも書くとよいと伝えた。そうすれば、
この修正が妥当かどうかを後から判断する助けになるはずからである。

    Index only table isn't dumped.
    A table that has no columns was detected as an index only table.

なお、この英語では日本語で言いたかったことの情報が抜けている感はある。
が、まぁ、雰囲気は伝わるのではないだろうか。無理かしら。。。

## その他

- 今日はいつもより質問してくれた。慣れてきて聞きやすくなったからなのか、聞かないといけないことが多かったのかわからない。（後者の気はする。）
- fluent-plugin-droongaとかgroonga-commandだと普通にテストも書いてくれるのに、rroongaだとテストを忘れるのはどうしてだろう。時間がなかったからかしら。（最後の少しあいた時間でやってもらった。）
