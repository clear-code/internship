# メンターのインターンシップメモ: 2013-07-23

15日目。9:45 - 18:00。

以下を実施した。今日は半分くらい一緒に作業した。

- fluent-plugin-droongaにselectコマンドのadapterを実装
- groonga-commandのリリース

## fluent-plugin-droongaにselectコマンドのadapterを実装

adapterの仕組みを作ったので、その上に
[selectコマンド用のadapterを実装](https://github.com/groonga/fluent-plugin-droonga/commit/f06f5c474683a4a22053732642800b24182c5188)
した。

最初の一歩が大変だった。後で話し合ったところ、一緒に作業をしているとき
でも、最初に作業の方向性を説明してから作業を開始するのがよさそうだとい
うことがわかった。ただ、作業を始める前にすべてのことがわかっているわけ
じゃないんだよなぁ。うーん。

以下、大変だったことを説明する。

まず、一番簡単なケースのテスト作成に着手した。一番簡単なケースは空のテー
ブルを検索し、 `_id` だけ出力するselectコマンドである。

    select EmptyTable --output_columns _id

これに対応するdroongaのsearchコマンドのリクエストと、そのsearchコマンド
のレスポンスを
[仕様](https://github.com/groonga/express-droonga/wiki/Message-format%3A-search-feature)
をもとに作成した。この時点では、searchコマンドのリクエストとレスポンス
をどのように変換するかは考えない。

一番簡単なケースの具体的なactualな値とexpectedな値がわかったので、それ
を使ってテストを作成した。以下のようなテストである。

    proxy = SpyProxy.new
    adapter = Droonga::GroongaAdapter.new(proxy)

    select_request = {...}
    search_response = {...}
    adapter.post(:select, select_request)

    # ↑でpostしたときに登録されたsearchのresponseを変換するブロック
    response_converter = proxy.posts.last[:block]
    assert_equal(expected_select_response,
                 response_converter.call(search_response)

このテストではsearchコマンドのレスポンスをselectコマンドのレスポンスに
変換するところだけをテストしているつもりである。selectコマンドのリクエ
ストをsearchコマンドのレスポンスにするところは気にしていない。しかし、
このテストでは両方テストしようとしているようにみえる、という意見をもらっ
た。

それでは、今作ろうとしているものと何をテストしたいかを整理しよう。

selectコマンドのadapterは以下の処理をする必要がある。

- groongaのselectコマンドのリクエストをdroongaのsearchコマンドのリクエストに変換
- droongaのsearchコマンドのレスポンスをgroongaのselectコマンドのレスポンスに変換

↑の両方を実現するのが `adapter.post(:select, select_request)` である。

で、これに対して以下をテストしたい。

- groongaのselectコマンドのリクエストをdroongaのsearchコマンドのリクエストに変換すること
- droongaのsearchコマンドのレスポンスをgroongaのselectコマンドのレスポンスに変換すること
- `adapter.post(:select, select_request)` がちゃんとしたselectコマンドのレスポンスを返すこと

前述のテストでは、2番目のレスポンス変換のみに注目しているつもりだった。
しかし、テストの中で3番目の `adapter.post` を使っていた。そのため、1つ
のことに集中しておらず、複数のことをやろうとしているようにみえるという
ことだった。

たしかに、テストに3番目の `adapter.post` が登場しているので、3番目のこ
とにも触れてしまっているので、言っていることは理解できる。そのため、実
際のコミットでは `adapter.post` が内部で使う「レスポンス変換処理メソッ
ド」を新しく定義し、それを使って2番目のレスポンス変換についてにテストす
ることにした。

意見をもらう前は、まず `adapter.post` を使って2番目のレスポンス変換のテ
ストを動かすようにしてコミット。テストを作って実装すると、「レスポンス
変換処理メソッド」をわけたいねぇという気持ちになってくるので「レスポン
ス変換処理メソッド」を作って、テストもそれを使ったものにする、みたいな
流れでやろうかと思っていた。まぁ、実装する前に「レスポンス変換処理メソッ
ド」を作ったほうがよさそう、というのが見えていたということなので、こん
な回りくどくやらなくてもよいのかもしれない。

というようなことがあった。 `adapter.post` を使っているけど2番目のレスポ
ンス変換のテストだけのつもりだった、みたいなことを説明してそれは伝わっ
たような気がするけど、だったら最初に流れを説明したほうがよかったね、と
いうことになった。


その後、epub-searcherで使っている範囲の変換機能を作った。

テストを追加する時、
[1つ目を追加](https://github.com/groonga/fluent-plugin-droonga/commit/bc760a0aa640fb2648b31c7ded77d2a31482ef3c)
、
[同じようなパターンの2つ目を追加](https://github.com/groonga/fluent-plugin-droonga/commit/d200e3310e3218a781b3f230860f09c31a00772c)
、その後、
[このテストで注目しているところだけをテストに残して他の部分をassert_XXXに移動](https://github.com/groonga/fluent-plugin-droonga/commit/ac95022a4a2230f7ee0344314c050b98438818f5)
と自然にやっていたのがよかった。テストの中は「何をテストしたいか」がわ
かりやすくなっていた方がよい。なぜならば、それがそのテストの中で大事な
ことだからである。

## groonga-commandのリリース

この他の未実装の機能は確認しないと進められないものばかりだったのでリリー
スに向けたパッケージ関連の作業をすることにした。今は、未リリースの
groonga-commandとrroongaに依存しているので、groonga-commandをリリースす
ることにした。

1.0.3ではTableCreateとColumnCreateに新機能が追加したが、それらについて
どうリリースノートに書けばよいか、ということを相談してもらった。ユーザー
が見たときにうれしくなるように書くとよいという基準を伝えたが、この基準
で考えることは難しいという事を以前の作業でわかったので、私がユーザーだっ
たら、という視点を伝えた。私がユーザーだったら新機能については以下のよ
うになっているとうれしい。

- リリースノートに新機能のリストが載っている。
- それぞれの新機能にはどんな機能かがわかる一言説明がついている。
- 新機能はリンクになっていて、一言説明を読んで気になったら詳細がわかるようになっている。

この観点を参考に、
[リリースノートには新機能をリスト](https://github.com/groonga/groonga-command/commit/15d84cbcfd59884c0c0dfe6255d44c4fd34ba72a)
することにした。それぞれの機能は、そのリファレンスのページにリンクする
ようにした。
[それぞれの機能に簡単なドキュメントをつけた](https://github.com/groonga/groonga-command/commit/446ec642ba33cc699409982204e9573e358a77b6)
。

こういう付加情報もあるとうれしいけどね、と伝えながらこんな感じでドキュ
メントを書く、ということをやった。付加情報を付けるということを伝えると、
ここでそこまで書かなくても…という反応だった。文章は短いほどよい、とい
う考え方だということは知っていたので、それ以上追加云々の話は広げず、簡
素なドキュメントにした。

## その他

- 絶賛開発中！のチームで開発しているものを使っているというかそれを題材にしていると、その場の判断で作業を進められないことがたまにあって進め方が難しい。実際の開発中のソフトウェアでもよくあることな気がするけど。期間が短いときはなるべく完結したものを題材にした方がよいのかも。
- やっぱり、伝えるのはなかなか難しい。伝わったと思った気になっていても、実はそうでないことが多いのかも。
