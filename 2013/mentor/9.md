# メンターのインターンシップメモ: 2013-07-08

9日目。9:30 - 18:00。

以下を実施した。違う作業をしていたためあまり見れなかった。よくない。

- groonga-clientの整理
- epub-searcherに検索機能を追加

## groonga-clientの整理

groonga-clientの整理はcolumn_listコマンドまでやり、そこで一区切りをつけ
てリリースすることにした。

### リリースするタイミング

ここで、どのタイミングでリリースするのがよいか、どこまでで区切りをつけ
るのがよいかという話になったので説明した。考えながら話したので、残念な
がらあんまりパッとした説明にはならなかった。

ソフトウェアを「完成」させることは難しい。これは、いつまでも手をかけ続
けたくなってしまうからである。「ある程度完成」した状態から何もかもを考
慮して対応した状態にしようとするといつまでたっても「完成」しない。その
ため、どこかで区切りをつけてリリースする。

では、どこで区切りをつけるか。区切りをつけるために、外部の制約条件を使
うことが多い。

たとえば、予算。収益があがらないと開発を継続することができないので、リ
リースして使える状態にする。Webサービスならベータバージョンとしてリリー
スしても、ユーザーがつけばお金を得ることもできる。

たとえば、時間。サクラの季節のためのソフトウェアを夏にリリースしては間
に合わない。サクラの季節に使うためにサクラの季節までにリリースする。こ
れは、締め切りタイプの時間の制限である。○○の発売に合わせてリリースや、
○○周年に合わせてリリースといったバリエーションもある。例えば、Ruby
2.0.0はRuby誕生20周年の日にリリースされた。

時間に関連して、他にも、定期的に時間を区切るタイプの制限もある。
groongaは毎月リリースしているのが、これがそのタイプである。29日に合わせ
て区切りをつけてリリースする。定期的にリリースすることを決めることによ
り、ソフトウェアをリリースできる状態を維持し続けることができる。長期間
リリースしていないとリリースするためのコストがあがり、どんどんリリース
しづらくなる。

他には、「今」自分が使う範囲の機能までできたときを区切りとする方法があ
る。これもわりと現実的な区切りのつけ方である。

今回は、今の状態で区切りをつけられるので、今をリリースするタイミングと
した。

### コミットメッセージに直したもののログを張る

Travis CIを使うようにしたところ
[Travis CI上では失敗](https://travis-ci.org/ranguba/groonga-client/jobs/8810569)
していることがわかった。これは、依存している
[gqtp gem](https://rubygems.org/gems/gqtp)が最新版（未リリース）ではな
いことが原因であることがわかった。そのため、まずはgqtp 1.0.4をリリースした。

その後、
[リリースしたgqtp 1.0.4を使う](https://github.com/ranguba/groonga-client/commit/7a99c0d699cf79c2373596e09748b07fbfb8f782)
ようにした。このとき、コミットメッセージにはどのようにテストが失敗して
いたかがわかるようにテストが失敗した時のメッセージを張っている。これは
よいコミットメッセージである。なぜなら、どのように失敗していたかに関す
る一次情報を含んでいるからである。一次情報があると、他の人が本当に妥当
な変更なのかどうかを確認することもできるし、後から見た時もどうしてこの
ように変更したかを判断することができる。同様に、warningを消したとき場合
もコンパイラーや言語処理系からのメッセージをコミットメッセージに含める
ことはよいことである。

ただし、一次情報の情報量が多すぎるときは、重要な部分のみを抜粋して詳細
についてはURLを張ることが望ましい。なんでもかんでも入れてしまうと大事な
情報が埋もれてしまい、有効に活用しづらくなる。

このようにコミットメッセージを書いた方がよいとは伝えていなかった気がす
るが実践していた。誰かのコミットメッセージを見たか、朝会でこんなコミッ
トがよかったと出ていたのを聞いて実践したのかもしれない。よいことである。

### なんでもよいオブジェクトがわかるようにする

外部のライブラリーや通信が必要なところではモックやスタブを使ってテスト
を書いている。このとき、
[本物のオブジェクトでなくてもよいところではObject.newでなんでもよいということを示すとよい](https://github.com/ranguba/groonga-client/commit/1c1a47060b9945cabfd7c3dfdf076ce790638f8a)
ということを伝えた。（気がする。）今思えば、Object.newではなく、stubで
もよかった。まぁ、どちらでも「何でもよいオブジェクト感」がコードで表現
されていると思う。

### 必要のないスタブを削除

privateなメソッドをテストするためにstubを使っていたが、
[sendで直接privateなメソッドを呼ぶようにした](https://github.com/ranguba/groonga-client/commit/177af1b95aed8d5484c75d91c08e7a9d46cfda56)
。

テストの中からprivateなメソッドを呼びたくなる場合は、privateなメソッド
の機能を他のクラスに移動してその機能をテストする方がすっきりする。しか
し、今回のように小さなクラスで小さなprivateメソッドの場合はそれはやりす
ぎである。

テストの中から直接privateなメソッドを呼ばないでテストするためにスタブを
使うくらいなら、sendで直接呼んでしまった方がよい。これは、スタブを使っ
てprivateメソッドの直接呼び出しを避けるほうが、テストが壊れやすくなるた
めである。これは、テストに依存しているオブジェクトが増えるためである。
スタブを使った機能へ依存している。

ただし、privateなメソッドのテストが1パターンしかない場合はスタブの方が
よい。1パターンしかない場合は網羅的なテストではないため、テストで確認し
たいことのメインはそのprivateなメソッドではないはずである。複数パターン
ある場合は、そのprivateなメソッドが主なテスト対象のはずなので、sendで呼
んで構わない。

### 何でもよいオブジェクトに名前をつける

変数を使わなくても済む場合でも変数を使ったほうがよい場合がある。それは、
そのオブジェクトがどういう役割をもつと思っているかを明示するためである。
変数を使ってオブジェクトに名前をつけることで、役割を明らかにする。今回
は、
[レスポンスオブジェクトに名前をつけた](https://github.com/ranguba/groonga-client/commit/24cbce1584cb535457dbaf86a2275057e8171dfe)
。

ここでは、モックは何を返してもよかった。そのため、Object.newを返すよう
にしていた。たしかに何を返してもよいということは伝わえるが、何の役割か
は伝わらない。そこで、レスポンスという役割をもつ何かのオブジェクトを返
していることを明示するために、responseという変数を導入した。これで、レ
スポンスを返しているんだ、ということがわかりやすくなった。

## epub-searcherに検索機能を追加

このあたりの作業はあんまり見守れなかった。が、ちゃんと画面もできていた
ので大きな障害はなかったみたい。snippetまで実装していたし。

まずはコマンドラインの検索ツールを作成した。（あれ、コミットされていな
い気がする。。。）これで、groonga-clientを使ってどうやって検索するかが
わかった。その後、groonga-clientを使ってWebの検索画面を作成した。

これは、1つずつ問題を解決していくやり方である。いきなりgroonga-clientを
使ってWebの画面を作るやり方もあったが、まずは、groonga-clientを使ったコ
マンドラインツールを作った。

コマンドラインツールの作り方はわかっているので、この作業でわからないこ
とはgroonga-clientの使い方だけである。このコマンドラインツールを作るこ
とにより、groonga-clientの使い方がわかったので、Webの検索画面を作るとき
にわからないことはWebの画面の作り方だけである。

このように、一つずつわからないことを解決していくと着実に進めていくこと
ができる。

## その他

テスト対象をどこにするか（どこを境界と考えるか）、どうすればピンときた
と言えるかという話をした。実際にテストをするときに、「○○という理由
で××を選ぶ」と説明できるようになればピンときたと言えそうということに
なった。

たしかにそんな気がするので、今度、ピンときているかを確認するためにこの
方法を使ってみよう。

Groonga::Client.open {}を使ってみて、ブロックの返り値がopenの返り値になっ
ていないことに気づいた。使わないとRubyらしいAPIになっているかどうか見逃
してしまうなぁと改めて思った。
