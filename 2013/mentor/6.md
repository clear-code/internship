# メンターのインターンシップメモ: 2013-06-27

6日目。9:30くらい？-18:00。

以下を実施した。昼下がりに別の作業をしていたので、まわりの人に協力をお
願いした。（selectコマンドの実装関連のとき。）

- groonga-clientのリリース
- groonga-commandのリリース
- groonga-clientへのselectコマンドの実装

## groonga-clientのリリース

groonga-clientをリリースするにあたり、リリース作業の流れについて説明し
た。

リリース作業の流れは以下の通りである。

- 前回のリリースからの変更点のうち「ユーザーにとって大事なこと」をまとめる
- 今回のリリースでのハイライトをまとめる
- gemをリリースする
- アナウンスする
- バージョン番号をあげる

groonga-clientは最初のリリースなので最初の2つの作業をする必要はない。ま
た、今回は広く使ってもらうためのリリースではなく、epub-searcherで使うた
めのリリースなのでアナウンスもしない。が、リリース作業を知ってもらうた
めにすべて説明した。

前回のリリースからの変更点と今回のリリースでのハイライトは
doc/text/news.mdにまとめる。フォーマットは以下の通りである。

    # NEWS

    ## 0.0.2 - 2013-06-29

    ここに0.0.2でのハイライトを英語でまとめる。

    ### Improvements

      * Supported XXX.
      * Added {XXX::YYY#zzz}.
      * Improved speed.

    ### Fixes

      * Fixed a crach bug on exit.
        [GitHub#1] [Reported by Anonymous Coward]

    ### Thanks

      * Anonymous Coward

    ## 0.0.1 - 2013-06-27

    ここに0.0.1でのハイライトを英語でまとめる。

    ### Improvements

      * ...

    ### Fixes

      * ...

    ### Thanks

      * ...

詳細は後述するが、構成は以下の通りとなっている。

- バージョンごとにセクションを作る
- セクションタイトルにはバージョンとリリース日付を含める
- セクション内にハイライトと変更点をまとめる
- 新しいバージョンほど上に配置する

セクションタイトルにリリース日付を含めるのは、該当バージョンがいつリリー
スされたのかを調べるときに便利だからである。

新しいバージョンほど上に配置するのは、新しいバージョンほど有用な情報な
ので先に目に付くようにするためである。

セクション内の内容については以下の通りである。

### 前回のリリースからの変更点のうち「ユーザーにとって大事なこと」をまとめる

前回のリリースからの変更点はバージョン管理システムのログ機能を使って確
認する。gitを使っていて、前回のバージョンに1.0.1タグがついている場合は
以下のようにすればよい。

    % git log --reverse -p 1.0.1..
    commit 1d1f84dfa0841076c523fd436339f6aab5382436
    Author: Kouhei Sutou <kou@clear-code.com>
    Date:   Thu Apr 11 17:24:17 2013 +0900

        Extract computing conditions code as a method
    ---
     lib/groonga/command/select.rb | 17 +++++++++++------
     1 file changed, 11 insertions(+), 6 deletions(-)

    diff --git a/lib/groonga/command/select.rb b/lib/groonga/command/select.rb
    index b06a09e..edcaedc 100644
    ...

各コミットは「commit ...」から始まる行で区切られているので、それをキー
にして順にコミットを確認していくとよい。

コミットの内容をすべて抜き出す必要はない。「ユーザーにとって大事なこと」
だけを抜き出す。この「ユーザーにとって」という視点がとても重要である。

例えば、以下はユーザーにとって大事ではない。

- 挙動は変わらず内部構造を整理しただけの変更。
- テストを追加した。

一方、以下のような変更はユーザーにとって大事である。

- APIを追加・削除・変更した。（ユーザーが使い方を変えなければいけないかもしれないから。）
- ドキュメントを追加・改良した。（ユーザーがより便利に使えるようになるかもしれないから。）
- 速度が向上した。

また、変更点はユーザーがわかるようにユーザーの視点に立って書くこと。例
えば、次の書き方はユーザーの視点に立っていない。

- 検索アルゴリズムをXXXからYYYに変更した。

ユーザーの視点に立って書くということは、ユーザーにとってどう変わるのか
を含めるという事である。例えば、次のように書く。

- 検索速度を10倍に高速化した。

詳細をどこまで書くのかの基準は難しいところであるが、ここで書いているの
は変更点のまとめなので、詳細はここに書かないという基準でよさそうである。
必要そうであれば、詳細は別のところに書いてまとめからはリンクを張るのが
バランスがとれていると思う。

変更点は以下の3つのセクションにわけてまとめる。

- Improvements（改良）
- Fixes（修正）
- Thanks（感謝）

「改良」セクションか「修正」セクションか悩むような変更点は「改良」セク
ションにいれる。そちらの方が開発が進んでいる感がでるためである。

変更点がユーザーからの報告を契機にしていた場合はまとめたときにそれに関
する情報を付け加える。具体的には「どこで報告されたか」と「だれが報告し
たか」という情報を付け加える。例えば、Taro YamadaさんがGitHubのIssue 3
番でバグレポートしてくれて、今回のリリースでそのバグを修正していたら以
下のように書く。

    ### Fixes

      * Fixed a crash bug.
        [GitHub#3] [Reported by Taro Yamada]

そして、報告者を「感謝」セクションにも書く。

    ### Thanks

      * Taro Yamada

このように、開発に協力してくれた人の成果とその人への感謝を明示的に示す
ことは重要である。これは、感謝していると思っているだけではその人には伝
わらないからである。感謝しているなら明示的に示さなければいけない。また、
単に感謝していると示すだけではなく、「具体的に○○に関して感謝している」
と伝えることは、より感謝していることが伝えたいからである。誰にでも見え
るところで感謝していることを伝えることも、より感謝していることを伝えた
いからである。

自分が他のフリーソフトウェアのプロジェクトに貢献し、感謝してもらった経
験からするとリリース時に自分が貢献したことを示してもらえるとうれしかっ
た。そのため、自分が貢献してもらったときも同じように感謝したいのである。

### 今回のリリースでのハイライトをまとめる

今回のリリースでのハイライトはまとめた変更点の中から以下の基準で選ぶ。
ハイライトをまとめるときもユーザーの視点で選ぶ。

- 特にオススメしたい変更点（例えば、劇的に高速になったとかすごい便利な機能が増えたとか）
- 注意しないといけない点（例えば、非互換があるので通常と違うアップデート方法にしないといけないとか）

また、アップデートした方がよいかの情報も付け加える。セキュリティー関連
のバグを修正したのならユーザー全員に迅速なアップデートをオススメする。
特定の環境でのみ発生する問題を修正したのならその環境以外の人はアップデー
トしなくても問題ないと伝える。といった具合である。自分がユーザーならアッ
プデートした方がよいのかどうかは気になるはずである。

### gemをリリースする

以下のコマンドでgitのタグをうったり、RubyGems.orgにpushしたりをまとめて
やってくれる。ただし、事前にRubyGems.orgへの登録が必要。これは5日目にやっ
てもらっていた。

    % rake release

このコマンドは中で `gem push` を実行しているが、一番最初に実行したとき
はRubyGems.orgのアカウント情報を入力しなければいけない。2回目以降はしな
くてもよい。

### アナウンスする

今回は広く使ってもらいたいというリリースではなく、epub-searcherで使いた
いというリリースなので、アナウンスは省略する。

### バージョン番号をあげる

リリースしたらバージョン番号をあげる。lib/groonga/client/version.rbの
中の `VERSION` のマイクロバージョン（一番右側の数字）を1つあげる。

    module Groonga
      class Client
        VERSION = "0.0.2"
      end
    end

とても重要な機能が入った場合や、非互換が発生するという場合、特別な時期
（年に一度の肉の日など）はメジャーバージョン（一番左の数字）を上げるが、
通常はマイクロバージョンをあげればよい。もし、マイクロバージョンが9まで
いっていたらマイナーバージョン（真ん中の数字）を上げる。例えば、0.0.9な
ら0.1.0にする。

## groonga-commandのリリース

groonga-commandのowner権限がなかったので準備だけした。一緒にコミットを
確認して
[リリースノートを作成](https://github.com/groonga/groonga-command/commit/4ffbebc922b075b1959bdf5e1785e03a70acfb76)
した。

その後、owner権限を手に入れたのでリリースした。

## groonga-clientへのselectコマンドの実装

groonga-clientでselectコマンドを使いたかったが、groonga-clientはまだ
selectコマンドをサポートしていなかった。そのため、予定を変更して
groonga-clientにselectコマンドサポートを追加することにした。

既存のテストでは実際のgroongaサーバーのように動くオブジェクトを作ってテ
ストするなど、工夫されている。しかし、いきなりそこまで工夫したテストを
書くことは難しいので、まずは、実際にgroongaのデータベースを作り、
groongaサーバーも立ててテストすることにした。既存のテストで工夫している
くらいまでにするのはその後にやることにした。

このように、まずは近いゴールを設定して進めていくやり方もある、という説
明をした。ゴールが遠いとゴールにたどり着くまでに紆余曲折してゴールを見
失ってしまう危険性がある。そうするとずっと作業をしているがいつまでも完
成しない、いわゆる「はまった」状態になってしまう。こうならないように、
ゴールより手前にマイルストーンを設定する方法があるということである。こ
のマイルストーンは、マイルストーンにたどり着く方法はだいたい見えていて、
試行錯誤を繰り返さなくても大丈夫そうというのが見えているというポイント
に設定する方が「はまった」状態を回避しやすくなる。

作業しながら、自分で「はまった」状態に気付いて、途中でこのまま進んだほ
うがいいのか作戦をたてなおしたほうがいいのか、などをできる人は明示的に
マイルストーンを設定しなくても大丈夫な気はする。

というようなことを説明し、テストの作成とselectコマンドの実装はよしはら
さんと一緒にやってもらった。

実際にテストを書きながら実装を確認すると、処理の大半はgroonga-commandを
使っているだけで、その部分はちゃんとテストされているようだった。また、
コマンド全体で共通する部分もちゃんとテストされているようだった。よって、
selectコマンドはテストしなくてもよいのではないか、という質問があった。

説明してもらいながら一緒にコードも見せてもらうとたしかにそんな感じだっ
た。ただ、何もテストしないと、「select」を「slect」にtypoしたりしていて
も気付かないということがありえるので、selectコマンド特有の箇所だけはテ
ストした方がよいと伝えた。その際、既存のテストされているところは改めて
テストする必要はないので、それらはモックやスタブを使って実際の処理をス
キップするのがよいと伝えた。

以前、モックとスタブの違いはあまりピンときていないと聞いていたので、モッ
クとスタブのついて説明した。

モックとスタブは同じところと違うところがある。

同じところは、モックとスタブはどちらも「実際の処理を行う代わりにあらか
じめ決めておいたテスト用の値を返す」機能を提供するというところである。

違うところは、モックには「あらかじめ決めておいた呼ばれ方をしたか」を確
認する機能があるが、スタブにはその機能がないというところである。これは、
モックとスタブで用途が違うためである。

モックはそれ自体がテストをする用途のためのものである。スタブはテストを
支援する用途のためのものである。今回の場合を例として説明する。

今は、groonga-clientのselectコマンドのテストを書きたい。selectコマンド
の機能は「groonga-commandの機能」と「groonga-client内にあるコマンドを実
行するための一般的な仕組み」をつなぎあわせて実現してる。そして、
「groonga-commandの機能」と「groonga-client内にあるコマンドを実行するた
めの一般的な仕組み」はテストされている。図にするといかのような状態である。

    groonga-clientのselectコマンド機能
    ↓ 以下をつなぎあわせて実現 ← 未テスト
    → groonga-commandの機能
      ↑はテスト済み
    → groonga-client内にあるコマンドを実行するための一般的な仕組み
      ↑はテスト済み

この場合、「groonga-clientのselectコマンド機能」のテスト項目は2つ考えられる。

- 「groonga-commandの機能」を正しく呼び出しているかを確認するテスト
- 「groonga-client内にあるコマンドを実行するための一般的な仕組み」を正しく呼び出しているかを確認するテスト

この「正しく呼び出しているか」を確認するためにモックを使う。もし、
「groonga-commandの機能」をテストしているときに、「groonga-client内にあ
るコマンドを実行するための一般的な仕組み」の部分も必要になったら、そこ
はスタブにする。なぜなら、テストでは1つの機能ずつ確認したいからである。
「groonga-commandの機能」をテストしているときはそのテストだけに着目する。
つまり、「groonga-client内にあるコマンドを実行するための一般的な仕組み」
の方はきちんと動いていると仮定する。きちんと動いていると仮定しているの
で、モックにある「あらかじめ決めておいた呼ばれ方をしたか」を確認する機
能は必要ないし、確認するべきではない。1つのテストで複数のことを確認して
しまう。そのため、スタブを使うことが適切である。

「groonga-commandの機能」を正しく呼び出しているかを確認するテストでは以
下のようにモックとスタブを使う。

    groonga-clientのselectコマンド機能
    ↓
    →（つなぎの部分）→ groonga-commandの機能
      ↑をモックにして「正しく呼び出しているか」を確認
    →（つなぎの部分）→ groonga-client内にあるコマンドを実行するための一般的な仕組み
      ↑をスタブにして実物がなくてもきちんと動いているようにみせる

「groonga-client内にあるコマンドを実行するための一般的な仕組み」を正し
く呼び出しているかを確認するテストでは以下のようにモックとスタブを使う。

    groonga-clientのselectコマンド機能
    ↓
    →（つなぎの部分）→ groonga-commandの機能
      ↑をスタブにして実物がなくてもきちんと動いているようにみせる
    →（つなぎの部分）→ groonga-client内にあるコマンドを実行するための一般的な仕組み
      ↑をモックにして「正しく呼び出しているか」を確認

という説明をして一人でやってみてもらった。コンセプトは伝わったような気
がするが、今回のコードではどこにモックを使うのがよいかがわからないとい
うことだったので、一緒に書くことにした。

みてみると、今回はスタブがなくてもよさそうだったので、
[モックを使って書いた](https://github.com/ranguba/groonga-client/commit/12eed3a713c65a6a8c0b48398cd307d2c72fd0c3)
。ただ、もう少しコードを見てみると、selectコマンドのレスポンスのオブジェ
クトはselectに特化したオブジェクトになっていた方がよさそうということが
わかった。特化したレスポンスのオブジェクトかどうかを確認するテストを書
くときは、スタブを使う必要がありそう。

今日はもう時間なのでレスポンスに関しては着手しないことにした。

その後、
[依存しているgroonga-commandのバージョン修正](https://github.com/ranguba/groonga-client/commit/834fd9fef1146988ab70879d52e55793ec58dbe0)
や
[YARD用の.gitignoreの更新](https://github.com/ranguba/groonga-client/commit/b4b50458b0ce6dc0cf2c2465d61c554852f560a3)
など細かいところを自発的に直してくれていた。

## その他

- リリース作業でやることの説明は興味をもって聞いてもらえた気がする。
- mockとstubの違いの説明も興味をもって聞いてもらえた気がする。
- 説明の仕方は変えていないつもりなので、内容によるのだろう。
- 説明を聞いているときは寡黙な感じをうけるが、説明してもらっているときはちゃんと伝えようと説明してくれている感じをうける。
- groonga-clientに必要な機能が足りないせいでepub-searcherから離れていっているが、モックとスタブについて説明する機会になったし、いい機会と捉えることにする。
