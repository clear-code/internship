# メンターのインターンシップメモ: 2013-07-22

14日目。9:45 - 18:00。

以下を実施した。今日はほとんど一緒に作業した。

- epub-searcherとfluent-plugin-droongaの接続テスト
- fluent-plugin-droongaの整理
- fluent-plugin-droongaにadapterプラグインを実装する

金曜日に着手したREADMEの作成は諦めることにした。これは、メンターがうま
く説明もできないし、うまく一緒に作業もできないためである。今回のインター
ンシップではドキュメント関連はやらないことにする。

## epub-searcherとfluent-plugin-droongaの接続テスト

express-droongaにgroonga互換インターフェイスを追加したので、groongaと同
じAPIで `table_create` と `create_command` を使えるようになっている。

そこで、droongaシステム（express-droonga + fluent-plugin-droonga）に対
してepub-searcherのデータベースセットアップスクリプトを動かして、データ
ベースにスキーマが定義されることを確認した。

express-droongaはデフォルトで使うポート番号がgroongaサーバーと異なるた
め、
[epub-searcherはデフォルトではexpress-droongaと同じポート番号を使う](https://github.com/ranguba/epub-searcher/commit/19e094022fe2f2d53f81d5a6c67f1089c754fa44)
ようにした。

## fluent-plugin-droongaの整理

最近、あまり見守れていなかったが、その間に書いてもらったコードで気にな
る部分があったので、一緒に整理していった。

### メソッド名とコンテキスト

まず、
[AddHandlerの `process_add` というメソッドから `_add` を削除](https://github.com/groonga/fluent-plugin-droonga/commit/aaa7cd14affe646b205d10168275aa37b72f0697)
した。

`process` だと一般的過ぎる名前ではないかという意見をもらった。たしかに
`process` だけみると「なんでも処理すれば `process` じゃないか」と思える。
ただ、自分なら、ここでは、 `process` だけみるのではなく、 `AddHandler`
のことも考えて読んでいる。ということで、コンテキストについて話した。

コンテキストとは訳すと文脈であるが、プログラムのコンテキスト（！）では
そのコードが評価される環境のことと考えるのがわかりやすい。たとえば、
`empty?` というメソッドを考えてみる。 `String#empty?` は「空文字列かど
うか」を返し、 `Array#empty?` は「要素がない配列かどうか」を返す。どち
らも同じ `empty?` だが、動作が異なる。どちらも「空かどうか」を調べてい
るという点では同じだが、「空」がどういうことかということは違う。この
「空」がどういうことかどうかを決めるのがコンテキストである。

というような話で説明してみた。伝わったような気はするが、この例が適切か
どうかはわからない。

話を戻すと、 `process` だけではたしかに一般的過ぎるが、 `AddHandler` が
`process` すると考えれば、「追加処理だろう」と思えるので、このコンテキ
ストでは一般的過ぎないと思う、という話をした。

### コミットの理由

コミットメッセージの1行目には何をしたかを書き、3行目以降には補足説明を
書く。補足説明には、例えば、どうしてこの変更が妥当かということを書く。
前述の
[AddHandlerの `process_add` というメソッドから `_add` を削除したコミット](https://github.com/groonga/fluent-plugin-droonga/commit/aaa7cd14affe646b205d10168275aa37b72f0697)
の1行目は以下のように「必要のないサフィックスを削除」となっている。

    add: delete a needless suffix

3行目以降に追加でメッセージを書くとしたら、例えば、「どうして必要がない
か」を説明するメッセージを書く。ここで、理由を書いてみませんか、と促し
たところ、「自明だから」ぐらいしか書けないなぁということだった。さらに
話をしてみると（たとえば、プログラミング初心者に説明するとしたら？とか
聞いたり）、理由がよくわかっていないからかもしれないということだった。

私だったら、こんな理由だなぁというのを話してみた。「`AddHandler` の中に
`process` があれば、それを見ただけで追加処理をするだろうなぁと思うが、
そこにさらに `process_add` と `add` がついていれば、もっと何か特別なこ
とをしているんじゃないかと思ってしまう。そして、それを調べようと
`process_add` の詳細を確認し、ようやく `add` は余計なものだったんだと気
づく。このように、必要のないものがついていると、読む人が『普通はつけな
くてもよいものを付けているので、ここは何か特別なことをしようとしている
のかもしれない！』と勘違いして理解するまでに時間がかかってしまうかもし
れないのでよくない、と思う。」

参考:
- [Rubyist Magazine - Ruby コードの感想戦 【第 1 回】 WikiR](http://magazine.rubyist.net/?0040-CodePostMortem) - コードから書いた人の意図を読もうとする人のコードの読み方
- [クリアなコードの作り方: 余計なことを書かない - ククログ(2012-05-21)](http://www.clear-code.com/blog/2012/5/21.html) - 以前、「余計なコードを書かない」ことがどうして大事かを説明したもの。

その後、こんな考え方を知った後だとどう思う？と考えてもらったところ、
「This suffix is meaningless.」となった。意味がないので必要のない、とい
うことなのでたしかにつながる。が、私が説明したものとは趣向が違う。

何が違うか考えてみたところ、私の方は「○○というデメリットがあるのでよ
くない。だから必要ない。」という具体的なデメリットのパターンを挙げてい
た。一方、考えてもらったものは具体的なデメリットではなく、「アンチパター
ンだからよくない。」みたいな感じである。アンチパターンから導き出させれ
るデメリットが共有されているのであれば、アンチパターンを示すだけで十分
だね、ということになった。どこかにアンチパターンとそのデメリットがまと
められた場所があるならそこへのリンクも添えるともっとよさそうだね、とい
うことになった。

### コードを書いた人の意図を表すコード

他には、
[クラスの比較ではなく性質を確認する述語メソッドにする](https://github.com/groonga/fluent-plugin-droonga/commit/dbcba8e60a1799d82982011332f95147f8bfad64)
整理をした。

ここでは、「テーブルがキーを持っているかどうか」がコードを書いた人がや
りたかったことである。元々は以下のように配列テーブルかどうかを確認して
いた。

    if table.class == Groonga::Array

これを、以下のように「このテーブルがキーをサポートしているかどうか」を
返す述語メソッドを使うように変えた。

    if table.support_key?

このように、直接クラスを調べてオブジェクトの性質を確認するよりも、調べ
たいことを返す述語メソッドを使う方が書いた人の意図を表すコードになる。
これをしているかどうかで読みやすさがだいぶ違ってくるので、とても大事な
ことである。

真偽値を確認したいときは、適切な述語がないか調べるとよいだろう。

### 他

その他にも細々いろいろ整理したが省略。。。
[詳細はこのあたり](https://github.com/groonga/fluent-plugin-droonga/compare/56654ad8deca6be11074df9fb0198fd79b067a9f...8e1460a4ce36b93fb750b4268cf77758bf1ec184)
。31コミット。

テスト名に同じ単語を使っていたらグループ化のサインみたいな話もした。あ
と、整理する時、壊さないで少しずつ整理していくより、0から作り直すのがや
りやすそう、みたいな話もした。今回は少しずつ整理していった。

## fluent-plugin-droongaにadapterプラグインを実装する

コードの整理が終わったので、adapterプラグインを実装した。まず、ホワイト
ボードに図を書きながらどんなAPIがあるといいかねぇみたいな話をして、方向
性を共有してからコードを書いていった。

adapterはproxyがないと動かないやつだけど、そこは
[mockとかstubを使ってテスト](https://github.com/groonga/fluent-plugin-droonga/commit/2a6f49d0d24d88fb17ce089f34422d4d6d51d667)
することにして、proxyなしでテストと実装を進めた。

最小限の機能はできた。

明日はadapterプラグインの1つとしてgroonga互換のAPIを提供するgroonga
adapterを作る。

## その他

- コミットメッセージでそのコミットの理由を書いてみようか、というのはドキュメントと同じ難しさを感じる。ドキュメントよりは答えがわかりやすいので難しくないけど、コードよりは難しい。
- どうしてそう思うかの「理由」を考えてもらうのはインターンシップでは大きすぎる話題かもしれない。ドキュメントと同じように。普段意識しないと思うので難しそう。
